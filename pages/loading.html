<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Ar - Conectando ao Servidor</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Syncopate:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/loading.css">

</head>

<body class="d-flex align-items-center justify-content-center">

    <div class="loader-content text-center">
        <div class="spinner-border spinner-gold mb-4" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>

        <h3 class="logo-text text-gold mb-3">CONECTANDO...</h3>

        <p class="text-white-50 small mb-4">
            Estamos acordando o servidor no Render.<br>
            Isso acontece após alguns minutos de inatividade e pode levar até 60 segundos.
        </p>

        <div class="progress-micro">
            <div class="progress-bar progress-bar-striped progress-bar-animated w-100"></div>
        </div>

        <p id="timer" class="mt-3 text-gold opacity-50 small">Tentando conexão...</p>
    </div>

    <script>
        // Script dentro de pages/loading.html
        const BACKEND_URL = "https://project-air-conditioning.onrender.com";
        let attempts = 0;

        async function poll() {
            attempts++;
            document.getElementById('timer').innerText = `Tentativa ${attempts}...`;

            try {
                const res = await fetch(`${BACKEND_URL}/login/health`);

                if (res.ok) {
                    document.getElementById('timer').innerText = "Sistema estável! Redirecionando...";

                    // Aguarda 2 segundos extras para garantir que o tráfego foi estabilizado no Render
                    setTimeout(() => {
                        const params = new URLSearchParams(window.location.search);
                        const destination = params.get('from') || '/pages/login.html';
                        window.location.href = destination;
                    }, 2000);

                } else {
                    throw new Error();
                }
            } catch (e) {
                setTimeout(poll, 3000); // Tenta novamente em 3 segundos
            }
        }
        window.onload = poll;
    </script>
</body>

</html>