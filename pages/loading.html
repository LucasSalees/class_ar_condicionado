<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Ar - Conectando ao Servidor</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/loading.css">

</head>
<body class="d-flex align-items-center justify-content-center">

    <div class="loader-content text-center">
        <div class="spinner-border spinner-gold mb-4" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        
        <h3 class="logo-text text-gold mb-3">CONECTANDO...</h3>
        
        <p class="text-white-50 small mb-4">
            Estamos acordando o servidor no Render.<br>
            Isso acontece após alguns minutos de inatividade e pode levar até 60 segundos.
        </p>

        <div class="progress-micro">
            <div class="progress-bar progress-bar-striped progress-bar-animated w-100"></div>
        </div>
        
        <p id="timer" class="mt-3 text-gold opacity-50 small">Tentando conexão...</p>
    </div>

    <script>
        const BACKEND_URL = "https://project-air-conditioning.onrender.com";
        let attempts = 0;

        async function poll() {
            attempts++;
            document.getElementById('timer').innerText = `Tentativa ${attempts}...`;

            try {
                // Timeout de 5 segundos para não travar a requisição
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${BACKEND_URL}/login/health`, { signal: controller.signal });
                clearTimeout(id);

                if (res.ok) {
                    const params = new URLSearchParams(window.location.search);
                    // Se não houver destino, volta para a index ou login
                    const destination = params.get('from') || '/index.html';
                    window.location.href = destination;
                } else { 
                    throw new Error(); 
                }
            } catch (e) {
                // Tenta novamente em 3 segundos
                setTimeout(poll, 3000);
            }
        }

        // Inicia a verificação
        window.onload = poll;
    </script>
</body>
</html>